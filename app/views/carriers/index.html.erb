<style>
  .badge a {
    color: #fff!important;
  }
  td.link a:visited {
    /* color: #6f060b!important; */
  }
</style>
<% if params[:controller] == "carriers" %>
  <style media="screen">
  .tooltip-inner {
    background-color: #6f060b!important;
  }
  .tooltip .arrow::before{
    border-right-color: #6f060b!important;
  }
  th {
    vertical-align: top;
  }
  </style>
<% end %>
<!-- begin panel -->
<div style="width: 100%">
  <div class="panel panel-scout">
    <div class="panel-heading">
      <div class="panel-heading-btn">
        <%= render 'carriers/header/buttons_and_links' %>
      </div>
      <h4 class="panel-title lp-header">Carriers</h4>
    </div>
    <div class="panel-body">
      <table class="table table-striped table-bordered display nowrap"  data-order="[[4, &quot;asc&quot;]]" id="carrier_table">
        <thead>
          <tr>
            <th></th>
            <th class="text-center"><i class="fas fa-clock"></i></th>
            <th>RO</th>
            <th>MC</th>
            <th>Name</th>
            <th>Cat</th>
            <th>ST/PV</th>
            <th>Ops Name</th>
            <th>Ops Phone</th>
            <th>Reef</th>
            <th>Lane</th>
            <th>Ops Email</th>
            <th>Appr</th>
            <th>Class</th>
            <th>CR</th>
            <th class="text-center">LstDateCon</th>
            <th>6M</th>
            <th>1M</th>
          </tr>
        </thead>
        <tfoot>
          <tr>
            <th></th>
            <th></th>
            <th>RO</th>
            <th>MC</th>
            <th>Name</th>
            <th>Cat</th>
            <th>ST/PV</th>
            <th>Ops Name</th>
            <th>Ops Phone</th>
            <th>Reef</th>
            <th>Lane</th>
            <th>Ops Email</th>
            <th>Appr</th>
            <th>Class</th>
            <th>CR</th>
            <th>LstDateCon</th>
            <th>6M</th>
            <th>1M</th>
          </tr>
        </tfoot>
        <tbody class="spacer">
          <% @carriers.each do |carrier| %>
            <tr>
              <td><%= carrier.id %></td>
              <td>
                <% if carrier.reminders %>
                  <% carrier.reminders.each do |reminder| %>
                      <%= reminder_to_html(reminder).html_safe %>
                  <% end %>
                <% end %>
              </td>
              <td class="text-center link"><%= carrier.relationship_owner_name.blank? ? '' : "#{link_to(covert_initials(carrier.relationship_owner_name), user_path(:id => carrier.relationship_owner))}".html_safe %></td>
              <td><%= carrier.mc_number %></td>
              <td class="link">
                <%= render "carriers/link", carrier: carrier %>
              </td>
              <td><%= carrier.category %></td>
              <td><%= carrier.state.nil? ? '' : generate_abv(carrier.state).upcase %></td>
              <td><%= carrier.poc_name %></td>
              <td><b><%= carrier.primary_phone.nil? ? '' : generate_phone_number("", carrier.primary_phone, carrier.primary_extension_number, carrier.primary_eligible_texting, carrier.primary_phone_type).html_safe %></b></td>
              <td class="text-center"><%= carrier.reefers %></td>
              <td>
                <% if !carrier.lane_origin.nil? && carrier.lane_origin != "" %>
                  <% carrier.lane_origin.split(',').map(&:to_s).each do |origin| %>
                    <%= generate_location2(origin, params[:controller], carrier.lane_id).html_safe %>
                  <% end %>
                <% end %>
                <% if !carrier.lane_destination.nil? && carrier.lane_destination != "" %>
                &rarr;
                <% carrier.lane_destination.split(',').map(&:to_s).each do |destination| %>
                  <%= generate_location2(destination, params[:controller], carrier.lane_id).html_safe %>
                <% end %>
              <% end %>
              </td>
              <td>
                <% if !carrier.contact_email.nil?  %>
                  <a href="mailto:<%= carrier.contact_email %>?Subject=Hello%20<%= carrier.poc_name.nil? ? '' :  carrier.poc_name.capitalize  %>" target="_top">
                    <%= carrier.contact_email.downcase %>&nbsp;<i class="far fa-envelope"></i>
                  </a>
                <% end %>
              </td>
              <td class="text-center"><%= carrier.approved ? "<b class='text-success'>Y</b>".html_safe : "<i class='text-danger'>N</i>".html_safe %></td>
              <td class="text-center"><%= shade_sales_priority(carrier.sales_priority).html_safe %></td>
              <td class="text-center"><%= carrier.complete_record ? "<b class='text-success'>Y</b>".html_safe : "<i class='text-danger'>N</i>".html_safe %></td>
              <td class="text-center"><%=  carrier.date_opened.nil? ? "" : carrier.date_opened.strftime('%m/%d/%Y').to_s %></td>
              <td class="text-center"><%= carrier.load_last_6_month %></td>
              <td class="text-center"><%= carrier.load_last_month %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script language="javascript">
  var user_id = "<%= current_user.id %>";
  $(document).ready(function() {
    filterAndSelectAllTable("carrier_table", 1);
    $('#send-mail-btn').on('click', function(){
        var rows_selected = $('#carrier_table').DataTable().column(0).checkboxes.selected();
        if (rows_selected.join(",") != ""){
          $.redirect('/carriers/compose_mail', {'ids': rows_selected.join(",")});
        }
    });
    $('#send-text-btn').on('click', function(){
        var rows_selected = $('#carrier_table').DataTable().column(0).checkboxes.selected();
        if (rows_selected.join(",") != ""){
          $.redirect('/carriers/compose_sms', {'ids': rows_selected.join(",")});
        }
    });
    checkboxes = "<div class='category_filter' style='display: inline;'><h5 style='display: inline; padding-right: 10px;'>P<input style='vertical-align: middle' type='checkbox' name='category' onchange='filterme()' value='P' <%= @carrier_categories[0] ? 'checked' : ''%>></h5>" +
                 "<h5 style='display: inline; padding-right: 10px;'>S<input style='vertical-align: middle' type='checkbox' name='category' onchange='filterme()' value='S' <%= @carrier_categories[1] ? 'checked' : ''%>></h5>" +
                 "<h5 style='display: inline; padding-right: 10px;'>O<input style='vertical-align: middle' type='checkbox' name='category' onchange='filterme()' value='O' <%= @carrier_categories[2] ? 'checked' : ''%>></h5>" +
                 "<h5 style='display: inline; padding-right: 25px;'>D<input style='vertical-align: middle' type='checkbox' name='category' onchange='filterme()' value='D' <%= @carrier_categories[3] ? 'checked' : ''%>></h5></div>"
    $('#carrier_table_filter').prepend(checkboxes)
  });
</script>
<script type="text/javascript">
  $(function() {
    table = $('#carrier_table').dataTable();
    filterme();
  })
  function filterme() {
    var categories = $('input:checkbox[name="category"]:checked').map(function() {
      return '^' + this.value + '\$';
    }).get().join('|');
    console.log(categories)
    table.fnFilter(categories, 5, true, false, false, false);

    var userCategories = $('input:checkbox[name="category"]').map(function() {
        return $(this).prop("checked");
    }).get().join(',');
    $.ajax({
      method: "PUT",
      url: "/api/users/" + user_id,
      data: {
        carrier_categories: userCategories
      }
    }).done(function(data) {
    });
  }
</script>
